% for user-defined macro
% フォントを変更したつもり 
% \usepackage[dvipdfmx, noto, unicode]{pxchfon}
% \usepackage[deluxe]{luatexja-preset}
% \usepackage[noto,jis2004,unicode]{pxchfon}
% \usepackage[sfdefault]{noto}
\usepackage[T1]{fontenc}
% % \usepackage[deluxe,jis2004,expert]{otf}
\renewcommand\kanjifamilydefault{\gtdefault}
\renewcommand\familydefault{\sfdefault}

% 全体のフォントを原の味フォントにする
% \usepackage[haranoaji, alphabet]{pxchfon}
\usepackage[relfont]{pxchfon}

% https://review-knowledge-ja.readthedocs.io/ja/latest/latex/uptex-fonts.html
% @<i>に明朝体を割り当て斜体にしない(texttt)
% \setmarugothicfont{haranoaji, alphabet}
% \setgothicfont{haranoaji, noalphabet}
% \renewcommand{\reviewit}[1]{\texttt{\userelfont\sffamily\gtfamily #1}}
\renewcommand{\reviewit}[1]{\textsf{\userelfont\sffamily\mcfamily #1}}

% @<b>{}にゴシック体の太字を割り当てる
\renewcommand{\reviewbold}[1]{\textbf{\userelfont\sffamily\gtfamily\bfseries #1}}

% @<chap}にゴシック体を割り当てる
\renewcommand{\reviewchapref}[2]{\hyperref[#2]{\userelfont\sffamily\gtfamily #1}}

% 行間を広くする
\renewcommand{\baselinestretch}{1.1}
\setlength{\parskip}{0.25\baselineskip} 
\usepackage{enumitem}
\setlist[itemize]{itemsep=.30\baselineskip, parsep=.15\baselineskip, topsep=.30\baselineskip}
\setlist[enumerate]{itemsep=.30\baselineskip, parsep=.15\baselineskip, topsep=.30\baselineskip}
\setlist[description]{itemsep=.30\baselineskip, parsep=.15\baselineskip, topsep=.30\baselineskip}

% ヘッダーの変更
\fancyhead{}% 既存の設定をキャンセル
% \fancyhead[LE]{\gtfamily\sffamily\bfseries\upshape \leftmark}% 左ページなら左側の見出し情報（一般に章名）
% \lhead[\gtfamily\sffamily\bfseries\upshape \leftmark]{}
% \lhead[\gtfamily\sffamily\bfseries\upshape \leftmark]{}
% \rhead[]{\gtfamily\sffamily\bfseries\upshape \rightmark}

% 章見出しの変更

% 図の余白をなくす
\setlength\intextsep{0pt}
\setlength\textfloatsep{0pt}

% 字下げをなくす
\setlength{\parindent}{0pt}

% コラムの見出し:「コラム」と表示しない, 見出し用フォント
\renewcommand{\reviewcolumnhead}[2]{%
{\noindent\headfont #2}}

% 章タイトルの上余白をなくす
\def\@makechapterhead#1{%
  %\vspace*{2\Cvs}% 欧文は50pt
  {\parindent \z@ \raggedright \normalfont
    \ifnum \c@secnumdepth >\m@ne
      \if@mainmatter
        \huge\headfont
		\@chapapp\thechapter\@chappos  
        \par\nobreak
        \vskip \Cvs % 欧文は20pt
      \fi
    \fi
    \interlinepenalty\@M
    \Huge \headfont #1\par\nobreak
    \vskip 1\Cvs}} % 欧文は40pt

\usepackage[x11names]{xcolor}
% セクション（モジュール）
\if@twocolumn
  \renewcommand{\section}{%
    \@startsection{section}{1}{\z@}%
    {0.6\Cvs}{0.4\Cvs}%
    {\normalfont\LARGE\headfont\raggedright\textcolor{green!100!red!70!blue!70!black!100}}}
\else
  \renewcommand{\section}{%
    \if@slide\clearpage\fi
    \@startsection{section}{1}{\z@}%
    {\Cvs \@plus.5\Cdp \@minus.2\Cdp}% 前アキ
    {.5\Cvs \@plus.3\Cdp}% 後アキ
    {\normalfont\LARGE\headfont\raggedright\textcolor{green!100!red!70!blue!70!black!100}}}
\fi


% サブセクション（サブモジュール）のカスタマイズ（色変更）
\if@twocolumn
  \renewcommand{\subsection}{\@startsection{subsection}{2}{\z@}%
    {\z@}{\if@slide .4\Cvs \else \z@ \fi}%
    {\normalfont\normalsize\headfont\textcolor{green!100!red!70!blue!70!black!100}}}
\else
  \renewcommand{\subsection}{\@startsection{subsection}{2}{\z@}%
    {\Cvs \@plus.5\Cdp \@minus.2\Cdp}% 前アキ
    {.5\Cvs \@plus.3\Cdp}% 後アキ
    {\normalfont\large\headfont\textcolor{green!100!red!70!blue!70!black!100}}}
\fi


% 指定位置に画像を表示する
%\usepackage{everypage}
% \AddEverypageHook{
%   \myoverlayimage
% }

\usepackage[absolute,overlay]{textpos}
\usepackage{pxtextpos}
\newcommand{\myoverlayimage}{
  \begin{textblock*}{85mm}(60mm,\dimexpr\paperheight-6.0mm-2mm)
    % \includegraphics[height=5mm]{images/dasa.png}% 高さ20mmの画像貼り付け
	% {©2025 kanbanguides.org | All Rights Reserved.} 
  \end{textblock*}
}


% 図のキャプションを消す（今回は使わないが）
\renewcommand\reviewimagecaption[1]{%
  \caption*{#1}}


% bothsidelineboxのカスタマイズ（今回は使わないが）
%  - 左右線
\DeclareTColorBox{rv@bothsidelinebox@nocaption}{ O{} }{%
  enhanced,breakable,skin=enhancedmiddle,
  frame hidden,interior hidden,top=0mm,bottom=0mm,boxsep=0mm,
  borderline={0.4mm}{0mm}{black},
%   borderline={0.4mm}{0.4mm}{black!50},
%   borderline={0.4mm}{0.8mm}{black!10},
  before upper={\parindent\reviewtcb@zw{1}},
  fontupper={\userelfont\sffamily\gtfamily}, % 本文をゴシック体にする
  #1}

\DeclareTColorBox{rv@bothsidelinebox@caption}{ m O{} }{%
  enhanced,breakable,skin=enhancedmiddle,
  frame hidden,interior hidden,top=0mm,bottom=0mm,boxsep=0mm,
  borderline={0.4mm}{0mm}{black},
%   borderline={0.4mm}{0.4mm}{black!50},
%   borderline={0.4mm}{0.8mm}{black!10},
  before upper={\parindent\reviewtcb@zw{1}},
  coltitle=black,
  bottomtitle=2mm,
  fonttitle={\reviewtcb@gtfamily\sffamily\bfseries},
  title={#1},
  fontupper={\userelfont\sffamily\gtfamily}, % 本文をゴシック体にする
  #2}

% squareboxのカスタマイズ（今回は使わないが）
%  - ごくシンプルな矩形
\DeclareTColorBox{rv@squarebox@nocaption}{ O{} }{%
empty, % スキン
left=3mm,right=5mm,top=6mm,bottom=7mm, % 内部パディング。デフォルトは4mm
arc=0mm, % コーナーの半径。デフォルトは1mm
% カラーは 色A!色Aの含み具合!色B。色Bを省略したときにはwhite
colback=white, %white, % 背景。デフォルトはblack!5!white
breakable, % ページ分断の許容
enhanced jigsaw, % 分断時に上下罫線を切り取り
pad at break=5.5mm, % 分断されたときの上下アキ。デフォルトは3.5mm
boxrule=0.0mm, % 線幅。toprule,bottomrule,leftrule,rightruleで個別指定も可
before upper={\parindent\reviewtcb@zw{1}}, % 内容の1行目を字下げ
fontupper={\userelfont\sffamily\gtfamily}, % 本文をゴシック体にする
#1} % オプション値で追加・上書き可能

\DeclareTColorBox{rv@squarebox@caption}{ m O{} }{%
empty,
left=3mm,right=5mm,top=6mm,bottom=7mm,
arc=0mm,
colback=white,
breakable,
enhanced jigsaw,
pad at break=4.5mm,
boxrule=.25mm,
before upper={\parindent\reviewtcb@zw{1}},
coltitle=black, % キャプション文字色
colbacktitle=white, % キャプション背景
fonttitle={\reviewtcb@gtfamily\sffamily\bfseries},
title={#1},
fontupper={\userelfont\sffamily\gtfamily}, % 本文をゴシック体にする
#2}

% leftsidelineboxのカスタマイズ（今回は使わないが）
%  - 左線
\DeclareTColorBox{rv@leftsidelinebox@nocaption}{ O{} }{%
  enhanced,breakable,skin=enhancedmiddle,
  frame hidden,interior hidden,top=0mm,bottom=0mm,right=0mm,boxsep=0mm,
  borderline west={0.4mm}{0mm}{black}, % westを付けて左のみにする
%   borderline west={0.4mm}{0.4mm}{black!50},
%   borderline west={0.4mm}{0.8mm}{black!10},
  before upper={\parindent\reviewtcb@zw{1}},
  fontupper={\textsf{\userelfont\sffamily\gtfamily}}, % 本文をゴシック体にする
  #1}

\DeclareTColorBox{rv@leftsidelinebox@caption}{ m O{} }{%
  enhanced,breakable,skin=enhancedmiddle,
  frame hidden,interior hidden,top=0mm,bottom=0mm,right=0mm,boxsep=0mm,
  borderline west={0.4mm}{0mm}{black},
%   borderline west={0.4mm}{0.4mm}{black!50},
%   borderline west={0.4mm}{0.8mm}{black!10},
  before upper={\parindent\reviewtcb@zw{1}},
  coltitle=black,
  bottomtitle=2mm,
  fonttitle={\reviewtcb@gtfamily\sffamily\bfseries},
  title={#1},
  fontupper={\textsf{\userelfont\sffamily\gtfamily}}, % 本文をゴシック体にする
  #2}


% topsidelineboxのカスタマイズ（今回は使わないが）
%  - 上線
\DeclareTColorBox{rv@topsidelinebox@nocaption}{ O{} }{%
enhanced,breakable,skin=enhancedmiddle,
frame hidden,interior hidden,top=0mm,bottom=3mm,right=2mm,boxsep=1mm,
borderline north={0.2mm}{0mm}{black}, % nouthを付けて上のみにする
borderline south={0.2mm}{0mm}{black}, % southを付けて下のみにする
%   borderline west={0.4mm}{0.4mm}{black!50},
%   borderline west={0.4mm}{0.8mm}{black!10},
before upper={\parindent\reviewtcb@zw{1}},
fontupper={\textsf{\userelfont\sffamily\gtfamily}}, % 本文をゴシック体にする
#1}

\DeclareTColorBox{rv@topsidelinebox@caption}{ m O{} }{%
enhanced,breakable,skin=enhancedmiddle,
frame hidden,interior hidden,top=0mm,bottom=3mm,right=2mm,boxsep=1mm,
borderline north={0.2mm}{0mm}{black}, % nouthを付けて下のみにする
borderline south={0.2mm}{0mm}{black}, % southを付けて下のみにする
%   borderline west={0.4mm}{0.4mm}{black!50},
%   borderline west={0.4mm}{0.8mm}{black!10},
before upper={\parindent\reviewtcb@zw{1}},
coltitle=black,
bottomtitle=2mm,
fonttitle={\textsf{\userelfont\sffamily\gtfamily}},
title={#1},
fontupper={\textsf{\userelfont\sffamily\gtfamily}}, % 本文をゴシック体にする
#2}

% 今回用のフッターとヘッダーの設定（以下全部）
\usepackage{fancyhdr}
% \usepackage{url}
\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\setlength{\footskip}{5mm}

% 通常ページ
\fancyfoot[C]{%
  \begin{minipage}[t]{\textwidth}
    {\color{green!100!red!70!blue!70!black!100}\rule{\textwidth}{0.75pt}}\\[1.5ex]
    \footnotesize
    \raggedright
    % {\sffamily
    % © 2019 \textendash \kern+0.3em2025 Orderly Disruption Limited, Daniel S. Vacanti, Inc. Offered for license under the Attribution ShareAlike license of Creative Commons, accessible at http://creativecommons.org/licenses/by-sa/4.0/legalcode and also described in summary form at http://creativecommons.org/licenses/by-sa/4.0/. By using this Kanban Guide, you acknowledge that you have read and agree to be bound by the terms of the Attribution ShareAlike license of Creative Commons.
    % }\\[2ex]
    % \hfill\textbf{The Kanban Guide \ | \ Page \thepage}
	\hfill\textbf{オープン版カンバンガイド \ | \ ページ \thepage}
  \end{minipage}
}

% plainスタイル（目次・章の頭など用）にも同じフッターを適用
\fancypagestyle{plain}{%
  \fancyhf{}
  \setlength{\footskip}{5mm}
  \fancyfoot[C]{%
    \begin{minipage}[t]{\textwidth}
      {\color{green!100!red!70!blue!70!black!100}\rule{\textwidth}{0.75pt}}\\[1.5ex]
      \footnotesize
      \raggedright
      % {\sffamily
      % © 2019 \textendash \kern+0.3em2025 Orderly Disruption Limited, Daniel S. Vacanti, Inc. Offered for license under the Attribution ShareAlike license of Creative Commons, accessible at http://creativecommons.org/licenses/by-sa/4.0/legalcode and also described in summary form at http://creativecommons.org/licenses/by-sa/4.0/. By using this Kanban Guide, you acknowledge that you have read and agree to be bound by the terms of the Attribution ShareAlike license of Creative Commons.
      % }\\[2ex]
    %   \hfill\textbf{The Kanban Guide \ | \ Page \thepage}
	\hfill\textbf{オープン版カンバンガイド \ | \ ページ \thepage}
    \end{minipage}
  }
}

% ドキュメント最初のページにも fancy スタイル適用
\AtBeginDocument{%
  \thispagestyle{fancy}
}


\makeatletter
% \let\cleardoublepage\clearpage
% \let\ORI@maketitle\maketitle
% \renewcommand{\maketitle}{\begingroup\let\clearpage\relax\ORI@maketitle\endgroup\thispagestyle{empty}}
% \makeatother
% 万一未定義でもエラーにしないための保険
\providecommand{\reviewtitlepage}{}
\providecommand{\reviewtableofcontents}{}

% Re:VIEW の既定の表紙・目次出力を止める
\renewcommand{\reviewtitlepage}{}
\renewcommand{\reviewtableofcontents}{}

% カスタム前付け（タイトル → 目次 → クレジット）
\newcommand{\customfrontmatter}{%
\thispagestyle{empty}%
% –– タイトルブロック ––
\begin{center}
{\large\itshape ナレッジワークにおける\par}
\vspace{0.5em}
{\Huge\bfseries オープン版カンバンガイド\par}

\vspace{1em}
\color{green!100!red!70!blue!70!black!100}\rule{\textwidth}{15pt}\par
\vspace{1em}
\color{black}\rule{\textwidth}{0pt}\par
{\Large 2025年7月\par}
\end{center}

% –– 目次（ページ分割を抑止）––
{\small
\begingroup\let\clearpage\relax
\setcounter{tocdepth}{2}% 必要なら調整
\tableofcontents
\endgroup
}

% –– クレジット（下寄せ）––
% \vspace{1em}
\vfill
% \noindent\footnotesize
{
  \noindent\scriptsize
This work, Open Guide to Kanban, is an adaptation of the Kanban Guide (May 2025 version) from \texttt{https://kanbanguides.org}, which is licensed under the Creative Commons Attribution\textendash ShareAlike 4.0 International License (CC BY\textendash SA 4.0). The original guide is © 2019 \textendash \kern+0.3em2025 Orderly Disruption Limited, Daniel S.\ Vacanti, Inc. Changes were made to the original. Licensed under CC BY\textendash SA 4.0. Portions highlighted in italic © 2025 Orderly Disruption Limited, licensed under CC BY\textendash SA 4.0. All other content is © 2019 \textendash \kern+0.3em2025 Orderly Disruption Limited, Daniel S.\ Vacanti, Inc., also licensed under CC BY\textendash SA 4.0.\par
}
\thispagestyle{empty} % ページ番号非表示
\clearpage
}
\makeatother

% 文書開始時に前付けを自動挿入
\AtBeginDocument{\customfrontmatter}

\let\cleardoublepage\clearpage

\makeatletter
\Urlmuskip=0mu plus 1mu\relax
\def\UrlBreaks{\do\/\do-\do\_\do\?\do\&\do\=\do\#\do\.\do\:}
\makeatother
\hypersetup{breaklinks=true}

\usepackage{seqsplit}